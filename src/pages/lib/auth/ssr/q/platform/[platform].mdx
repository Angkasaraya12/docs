export const meta = {
  title: `Use with Server-Side Rendering (SSR)`,
  description: `Learn more about how to use Amplify Auth with Server-Side Rendering (SSR).`,
};

<InlineFilter filters={["js"]}>

[comment]: # (source content from /src/fragments/lib/ssr/js/getting-started.mdx ; /src/fragments/lib/ssr/js/next-js-callout.mdx ; /src/fragments/start/getting-started/next/api.mdx ; aws.amazon.com/blogs/mobile/ssr-support-for-aws-amplify-javascript-libraries/)

Server-Side Rendering (SSR) can help improve your search engine optimization, security, and load speed. Amplify JavaScript requires slight modifications from how you would use it in a client-only environment to work well with server-rendered pages. In this guide we will review how SSR helps with keeping your apps secure and how to implement Auth with SSR and API routes.

<Accordion title='Review the tradeoffs between client-side and SSR auth flows' headingLevel='4' eyebrow='Learn more'>

You can use client-side or SSR, or a combination of the two, to help reduce security risks for authentication.
However, there are tradeoffs for each to keep in mind.

| Auth Type | Benefits | Constraints |
|-|-|-|  
| Client-Side | - Faster page loads after initial authentication <br/>- Less server load <br/>- Simpler setup <br/>- Credentials not exposed in backend since managed client-side in browser <br/>- Tokens are transient and less vulnerable if leaked <br/> -No roundtrips to the server for authorization | - Initial load authentication delay <br/>- SEO unfriendly <br>- Impacts user experience <br>- Client-side security risks |
| Server-Side | - Authentication on initial page load <br/>- SEO friendly <br/>- Improved user experience <br/>- Credentials never enter browser <br/>- Access tokens are not exposed in the browser <br/>- Session authorization is done on each request | - Slower first load time <br/>- More server load <br/>- Server-side security risks |

</Accordion>

Before you begin, you will need:

- An Amplify project with the Auth category configured
- The Amplify libraries installed and configured
- Node.js backend available to run React server-side
- Server route handlers and templates set up to handle requests

<Callout warning>

SSR functionality in Amplify was primarily built for compatibility with Next.js [page components](https://nextjs.org/docs/basic-features/pages), and their [getServerSideProps data fetching mechanism](https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props). Compatibility with other frameworks or Next.js features cannot be guaranteed.

</Callout>

## Use Auth with SSR and API Routes

You can enable user authentication on both client and server using Amplify Auth. Server-side code can securely access user data to render pages using protected API routes. [API Routes in Next.js](https://nextjs.org/docs/pages/building-your-application/routing/api-routes) help you create API endpoints as any file in the **pages/api/**** folder is treated as an API endpoint instead of a page. This helps you set up secure API requests that respond to the state of the authenticated user.

Before you configure your API requests on your server, you will first enable SSR by updating your client app. When using the Amplify CLI, the **aws-exports.js** file is created and updated automatically for you based upon the resources you added and configured. For client-only apps, `Amplify.configure(awsExports)` is all you need. However, to enable SSR support, you will also add `ssr: true`:

```js
import { Amplify } from "aws-amplify";
import awsExports from "../src/aws-exports";

Amplify.configure({ ...awsExports, ssr: true });
```

By providing `ssr: true`, Amplify persists credentials on the client in cookies so that subsequent requests to the server have access to them.

<Callout>

**Note**: Once the [vercel/next.js#16977](https://github.com/vercel/next.js/issues/16977) is resolved, you can hoist `Amplify.configure` into **pages/_app.js**.  Until then, be sure that all **pages/*** run `Amplify.configure({ ...awsExports, ssr: true })`.

</Callout>

Once your application is configured with `ssr: true`, the client-side credentials are passed to the server via cookies. The `withSSRContext` utility then creates an instance of `Amplify` scoped to a single request (`req`) using those cookie credentials.

For client-side code rendered in the browser, your page should continue using top-level imports as usual:

```js
import { Amplify, API } from "aws-amplify";
import awsExports from "../src/aws-exports";

Amplify.configure({ ...awsExports, ssr: true });

export default function HomePage({ posts = [] }) {
  const [posts, setPosts] = useState(posts);

  useEffect(() => {
    // Notice how the client correctly uses the top-level `API` import
    API.graphql({ query: listPosts }).then(({ data }) => setPosts(data.listPosts.items));
  }, [])

  return ( ... );
}
```

But when on the server, use `withSSRContext({ req?: ServerRequest })`. This will give you access to the currently authenticated user session using the Amplify API with the request object. This SSR configuration will need to be done with each API route - in this case it is returning data for the authenticated user:

```js
import { Amplify, API, withSSRContext } from "aws-amplify";

export async function getServerSideProps({ req }) {
  // Notice how the server uses `API` from `withSSRContext`, instead of the top-level `API`.
  const SSR = withSSRContext({ req })
  const { data } = await SSR.API.graphql({ query: listPosts });

  return {
    props: {
      posts: data.listPosts.items
    }
  }
}
```

<Callout>

**Note:** Server-side functions that don't have a req object (e.g. Next.js' `getStaticProps` and `getStaticPaths`) should still use `withSSRContext()`. Please note that it is **not** possible to perform authenticated requests with Amplify when using these functions.

</Callout>

### Use Auth with Next.js to securely fetch data at request time

When you need a page with data server-side rendered at request time you can [use the `getServerSideProps` method with Next.js Pages Router](https://nextjs.org/docs/pages/building-your-application/data-fetching/get-server-side-props). This will ensure that pages are pre-rendered on each request and pass any data as `props`.

When you combine this with `withSSRContext` you can call the authenticated API route from `getServerSideProps` to call your data directly. This will allow you to only provide data to authenticated users. Here is an example fetching from a To do app:

```js
import { withSSRContext } from 'aws-amplify';
import { listTodo } from '../src/graphql/queries';

export async function getServerSideProps(context) {
  const { API } = withSSRContext(context)
  let TodoData
  try {
    TodoData = await API.graphql({
      query: listTodo,
      authMode: "AMAZON_COGNITO_USER_POOLS"
    });
    console.log('TodoData: ', TodoData)
  } catch (err) {
    console.log("error fetching Todo: ", err)
  }
  return {
    props: {
      Todo: TodoData ? TodoData.data.listTodo.items : null
    }
  }
}
```

<Callout>

**Note:** When using `getServerSideProps` each request (`req`) on the server creates a copy of Amplify that scopes credentials, data, and storage to *just one* request. 

</Callout>

You should now be able to use Auth with SSR and API routes and integrate these routes with `getServerSideProps` when needed for your data.

## Use Amplify with Next.js App Router

Amplify JavaScript can be used with the Next.js App Router ("app/" directory) for Next.js v13.4 and later. You will need to apply the following changes:

First, run `Amplify.configure({ ...awsExports, ssr: true })` in **both** the client-side and server-side code. In order to use Amplify with Next.js App Router, you **must** run `Amplify.configure()` in both Client and Server Components. The `ssr` option **must** be enabled.

Here is an example with the Next.js App Router Client Component containing your login flow (e.g. `app/page.tsx`):

```js
'use client';

import { Amplify } from 'aws-amplify';
import awsExports from '@/aws-exports';

Amplify.configure({ ...awsExports, ssr: true });

export default function Home() {
  return (
    {/* Render a login form for your users */}
  )
}
```

And here is how this looks in the Next.js App Router Server Component (e.g. `app/posts/page.tsx`):

```js
import { Amplify } from 'aws-amplify';
import awsExports from '@/aws-exports';

Amplify.configure({ ...awsExports, ssr: true });

export default async function Page() {
  // ...
}
```

Next, prepare a request object for `withSSRContext` to perform server-side operations that require authentication. 

Here is an example a Next.js App Router Server Component that queries data from GraphQL (e.g. `app/posts/page.tsx`):

```js
import { Amplify, withSSRContext } from 'aws-amplify';
import { headers } from 'next/headers';
import { listPosts } from '@/graphql/queries'; 
import awsExports from '@/aws-exports';

Amplify.configure({ ...awsExports, ssr: true });

export default async function Page() {
  // Construct a req object & prepare an SSR enabled version of Amplify
  const req = {
    headers: {
      cookie: headers().get('cookie'),
    },
  };
  const SSR = withSSRContext({ req })

  const { data } = await SSR.API.graphql({ query: listPosts });

  // ...
}

```

You can now use the Next.js App Router with authentication for SSR.

## Use Auth with Next.js Server Actions to mutate data

You can also user [Server Actions on Next.js](https://nextjs.org/docs/app/api-reference/functions/server-actions) to write and update data directly to your server without an API Route handler. 

For example, You can create and manage persistent sessions in a database by interacting with Amplify Auth in a Server Action in the Se:

```
TODO


```


## Use Auth with Next.js Middleware

You can use [Middleware in Next.js](https://nextjs.org/docs/pages/building-your-application/routing/middleware) to run code before loading the page. You can reuse this logic to run authentication checks across multiple pages. 

For example, you might use Middleware to check if a user is authorized and redirect unauthorized users from a page before any content is rendered:

```js
import { NextResponse } from 'next/server'
import { Amplify, withSSRContext } from 'aws-amplify';

export async function middleware(req) {

  // Check auth 
  const user = await Auth.currentAuthenticatedUser();

  if (!user) {
    return NextResponse.redirect('/login');
  }

  // Allow request to continue
  return NextResponse.next();

}
```

## Use HTTP only cookies with Next.js


</InlineFilter>
