As of v2, Amplify Library iOS is now Amplify Library for Swift. Amplify Library for Swift supports iOS 13+ and macOS 10.15+, and ships with APIs that leverage Swift Concurrency (async/await) to return values. There are a few things you need to know if you are upgrading to this latest version.

## What's changed

We have re-written our APIs to support idiomatic Swift features including [structured concurrency](#structured-concurrency-asyncawait-pattern) and [combine support](#combine-support). We have also changed [how you access the underlying SDK](#escape-hatches) (keep in mind that the AWS SDK for Swift is still in Developer Preview). 

The Predictions APIs do not currently have an upgrade plan. We will update this guide as soon as they do.

## Using the new Swift features with Amplify APIs

### Structured Concurrency (async/await pattern)

All our APIs have been refactored to follow the async/await structured concurrency pattern. The following is an comparison of how you would implement Sign-In for your authentication flows:

#### Implementing Sign-In in Amplify Library iOS / v1 

Previously, you would use a callback API like so:

```swift
func signIn(username: String, password: String) {
    Amplify.Auth.signIn(username: username, password: password) { result in
        switch result {
        case .success:
            print("Sign in succeeded")
        case .failure(let error):
            print("Sign in failed \(error)")
        }
    }
}
```

#### Implementing Sign-In in Amplify Library for Swift / v2

Now with Amplify Library for Swift, you would use the async/await pattern like so:

```swift
func signIn(username: String, password: String) async throws {
    let signInResult = try await Amplify.Auth.signIn(
        username: username, 
        password: password
    )
    if signInResult.isSignedIn {
        print("Sign in succeeded")
    }
}
```

### Combine support

Amplify for Swift supports Swift Concurrency (async/await) when returning values. For example, the following returns an array of type `Geo.Place` with search results for coffee shops:

```swift
let places = try await Amplify.Geo.search(for "coffee")
```

Some APIs do not return a simple result, such as those that return subscriptions or provide progress updates. In cases where multiple values are returned over time, Amplify typically provides an `AmplifyAsyncSequence` or `AmplifyAsyncThrowingSequence`. These types conform to the `AsyncSequence` protocol and can be iterated over asynchronously. The following example subscribes to the creation of new Todos:

```swift
let subscription = Amplify.API.subscribe(
    request: .subscription(of: Todo.self, type: .onCreate)
)
```

#### Amplify.Publisher

In order to support Combine, Amplify Library for Swift also includes Amplify.Publisher, which can be used to get Combine Publishers like the ones listed above for Amplify APIs by providing static methods to create Combine Publishers from Tasks and AsyncSequences.

The following examples show how to create Combine Publishers for the above API calls:

```swift
let sink = Amplify.Publisher.create {
    try await Amplify.Geo.search(for "coffee")
}
    .sink { completion in
        // handle completion
    } receiveValue: { value in
        // handle value
    }
```

```swift
let subscription = Amplify.API.subscribe(
    request: .subscription(of: Todo.self, type: .onCreate)
)

let sink = Amplify.Publisher.create(subscription)
    .sink { completion in
        // handle completion
    } receiveValue: { value in
        // handle value
    }
```

#### Cancellation

When using `Amplify.Publisher`, cancelling a subscription to a publisher also cancels the underlying task. Note, however, that in the case of progress sequences, this would only cancel progress updates, and not the associated task such as a file upload or download. Those associated tasks would need to be cancelled separately, either by calling `.cancel()` on the task itself or by cancelling the parent task.

#### `Hub.publisher(for:)`

The Amplify Hub category exposes only one Combine-related API: `Hub.publisher(for:)`, which returns a publisher for all events on a given channel. You can then apply the standard Combine [`filter`](https://developer.apple.com/documentation/combine/anypublisher/filter(_:)) operator to inspect only those events you care about.

## Escape Hatches

Amplify Library for Swift, also changes the way you access the underlying SDK. Now you have access to the AWS SDK for Swift. The following is an example on how you would SDK calls with Amplify Library for Swift:

```swift
import AWSPinpointAnalyticsPlugin

do {
    // Retrieve the reference to AWSPinpointAnalyticsPlugin
    let plugin = try Amplify.Analytics.getPlugin(for: "awsPinpointAnalyticsPlugin")
    guard let analyticsPlugin = plugin as? AWSPinpointAnalyticsPlugin else {
        return
    }
    
    // Retrieve the reference to PinpointClientProtocol from AWS SDK for Swift
    let pinpointClient = analyticsPlugin.getEscapeHatch()

    // Make requests using pinpointClient...
    // ...
} catch {
    print("Get escape hatch failed with error - \(error)")
}
```

**Note:** While the Amplify Library for Swift is production ready, please note that the underlying AWS SDK for Swift is currently in Developer Preview, and is not yet intended for production workloads. You can read about the SDK's ongoing development in [this additional documentation](https://github.com/awslabs/aws-sdk-swift/blob/main/docs/stability.md).