## Customization (Developer Preview)

### Customize Object Key Path

You can customize your key path by defining a prefix resolver:

```dart
import 'package:amplify_flutter/amplify_flutter.dart';
import 'package:amplify_auth_cognito/amplify_auth_cognito.dart';
import 'package:amplify_storage_s3_dart/amplify_storage_s3_dart.dart';

// Define your own prefix resolver, that implements to `S3PrefixResolver`
class MyDeveloperPrefixResolver implements S3PrefixResolver {
  @override
  Future<String> resolvePrefix({
    required StorageAccessLevel accessLevel,
    String? identityId,
  }) async {
    if (accessLevel == StorageAccessLevel.guest) {
      return 'myPublicPrefix/';
    }
    late String accessLevelPrefix;

    if (accessLevel == StorageAccessLevel.protected) {
      accessLevelPrefix = 'myProtectedPrefix/';
    } else {
      accessLevelPrefix = 'myPrivatePrefix/';
    }

    final targetIdentityId =
        identityId ?? await getCurrentUserIdentityId();

    return '$accessLevelPrefix$targetIdentityId/';
  }

  Future<String> getCurrentUserIdentityId() async {
    final userSession = await Amplify.Auth.fetchAuthSession(
      options: const CognitoSessionOptions(
        getAWSCredentials: true,
      ),
    );
    return (userSession as CognitoAuthSession).identityId!;
  }
}
```

Then configure the storage plugin with the resolver.

```dart
final storagePlugin = AmplifyStorageS3(
  prefixResolver: const MyDeveloperPrefixResolver(),
);

await Amplify.addPlugin(storagePlugin);
```

Add the IAM policy that corresponds with the prefixes defined above to enable read, write and delete operation for all the objects under path *myPublicPrefix/*:
```xml
"Statement": [
    {
        "Effect": "Allow",
        "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject"
        ],
        "Resource": [
            "arn:aws:s3:::your-s3-bucket/myPublicPrefix/*",
        ]
    }
]
```
If you want to have custom *private* path prefix like *myPrivatePrefix/*, you need to add it into your IAM policy:
```xml
"Statement": [
    {
        "Effect": "Allow",
        "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject"
        ],
        "Resource": [
            "arn:aws:s3:::your-s3-bucket/myPrivatePrefix/${cognito-identity.amazonaws.com:sub}/*"
        ]
    }
]
```
#### Passthrough PrefixResolver

If you would like no prefix resolution logic, such as performing S3 requests at the root of the bucket, you can use the `PassThroughPrefixResolver` provided by `amplify_storage_s3` package.

```dart
import 'package:amplify_storage_s3_dart/amplify_storage_s3_dart.dart';

final storagePlugin = AmplifyStorageS3(
  prefixResolver: const PassThroughPrefixResolver(),
);

await Amplify.addPlugin(storagePlugin);
```

You will need to update your permissions to allow access to your custom prefix. Go to s3.console.aws.amazon.com then go to IAM -> Roles.

Choose the Role associated with your Amplify app labeled [AMPLIFY_APP_NAME]-[ENV]-unAuthRole or authRole (for signed in users).

Under permissions, modify the relevant policy to enable read, write and delete operation for all the objects under path _myPublicPrefix/_.

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": ["s3:PutObject", "s3:GetObject", "s3:DeleteObject"],
      "Resource": ["arn:aws:s3:::your-s3-bucket/myPublicPrefix/*"],
      "Effect": "Allow"
    }
  ]
}
```

If you want to have custom _private_ path prefix like `myPrivatePrefix/`, you need to add permissions to the IAM policy of your authenticated users. For example, for the given IAM principal (default authenticated role for Amplify projects):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": ["s3:GetObject", "s3:PutObject", "s3:DeleteObject"],
      "Resource": [
        "arn:aws:s3:::your-s3-bucket/myPrivatePrefix/${cognito-identity.amazonaws.com:sub}/*"
      ],
      "Effect": "Allow"
    }
  ]
}
```

#### Passthrough PrefixResolver

If you would like no prefix resolution logic, such as performing S3 requests at the root of the bucket, create a prefix resolver that returns an empty string:

```dart
class PassThroughPrefixResolver implements StorageS3PrefixResolver {
  @override
  Future<String> resolvePrefix({
    required StorageAccessLevel storageAccessLevel,
    String? identityId,
  }) async {
    return '';
  }
}
```
