## Customization

As mentioned above, configuring an access level in storage upload options will cause your files to be uploaded with a _public/_ _protected/_ or _private/_ prefix.

If you would like your items to be stored with a different prefix, you can customize your key path by defining a prefix resolver:

```dart
import 'package:amplify_flutter/amplify_flutter.dart';
import 'package:amplify_auth_cognito/amplify_auth_cognito.dart';
import 'package:amplify_storage_s3_dart/amplify_storage_s3_dart.dart';

// Define your own prefix resolver, that implements to `S3PrefixResolver`
class MyDeveloperPrefixResolver implements S3PrefixResolver {
  @override
  Future<String> resolvePrefix({
    required StorageAccessLevel accessLevel,
    String? identityId,
  }) async {
    if (accessLevel == StorageAccessLevel.guest) {
      return 'myPublicPrefix/';
    }
    late String accessLevelPrefix;

    if (accessLevel == StorageAccessLevel.protected) {
      accessLevelPrefix = 'myProtectedPrefix/';
    } else {
      accessLevelPrefix = 'myPrivatePrefix/';
    }

    final targetIdentityId =
        identityId ?? await getCurrentUserIdentityId();

    return '$accessLevelPrefix$targetIdentityId/';
  }

  Future<String> getCurrentUserIdentityId() async {
    final userSession = await Amplify.Auth.fetchAuthSession(
      options: const CognitoSessionOptions(
        getAWSCredentials: true,
      ),
    );
    return (userSession as CognitoAuthSession).identityId!;
  }
}
```

Then configure the storage plugin with the resolver.

```dart
final storagePlugin = AmplifyStorageS3(
  prefixResolver: const MyDeveloperPrefixResolver(),
);

await Amplify.addPlugin(storagePlugin);
```

### Defining IAM Policy for Custom Prefix

You will need to update the IAM policy to enable read, write and delete operation for all the objects under your custom prefix path.

Directly updating the relevant IAM role policies in AWS policies will be overwritten for future calls of Amplify push.

Instead, [override Amplify IAM roles](https://docs.amplify.aws/cli/project/override/) for `authRole` and/or `unauthRole` by adapting [this example](https://docs.amplify.aws/cli/project/override/#example-modify-authroles-iam-policies).

Note that the `policyName` should match a pre existing policyName that Amplify CLI created for your app.

Add the IAM policy that corresponds with the prefixes defined above to enable read, write and delete operation for all the objects under path _myPublicPrefix/_:

```xml
"Statement": [
    {
        "Effect": "Allow",
        "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject"
        ],
        "Resource": [
            "arn:aws:s3:::your-s3-bucket/myPublicPrefix/*",
        ]
    }
]
```

If you want to have custom _private_ path prefix like _myPrivatePrefix/_, you need to add it into your IAM policy:

```xml
"Statement": [
    {
        "Effect": "Allow",
        "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject"
        ],
        "Resource": [
            "arn:aws:s3:::your-s3-bucket/myPrivatePrefix/${cognito-identity.amazonaws.com:sub}/*"
        ]
    }
]
```

#### Passthrough PrefixResolver

If you would like no prefix resolution logic, such as performing S3 requests at the root of the bucket, create a prefix resolver that returns an empty string:

```dart
class PassThroughPrefixResolver implements StorageS3PrefixResolver {
  @override
  Future<String> resolvePrefix({
    required StorageAccessLevel storageAccessLevel,
    String? identityId,
  }) async {
    return '';
  }
}
```
